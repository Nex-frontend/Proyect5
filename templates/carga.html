{% extends 'base.html' %}
{% block content %}
<h2>Página de carga</h2>
<div id="drop-area" class="drag-area">
  Arrastra y suelta archivos aquí o haz clic para seleccionar.
  <input id="fileElem" type="file" multiple style="display:none" />
</div>

<h3>Registros cargados</h3>
<table role="grid">
  <thead><tr><th>Folio</th><th>Nombre</th><th>CURP</th><th>RFC</th></tr></thead>
  <tbody id="records-body">
    {% for r in records %}
    <tr><td>{{ r.folio }}</td><td>{{ r.nombre }}</td><td>{{ r.curp }}</td><td>{{ r.rfc }}</td></tr>
    {% endfor %}
  </tbody>
</table>

<script>
const dropArea = document.getElementById('drop-area');
const fileElem = document.getElementById('fileElem');

['dragenter','dragover','dragleave','drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false)
});

function preventDefaults (e) { e.preventDefault(); e.stopPropagation(); }

dropArea.addEventListener('drop', handleDrop, false);
dropArea.addEventListener('click', () => fileElem.click());
fileElem.addEventListener('change', (e) => handleFiles(e.target.files));

function handleDrop(e) { handleFiles(e.dataTransfer.files); }

function handleFiles(files) {
  const formData = new FormData();
  for (let i=0; i<files.length; i++) formData.append('files', files[i]);
  fetch('{% url 'api_upload' %}', { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }, body: formData })
    .then(r => r.json()).then(data => { if (data.ok) location.reload(); });
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}
</script>
{% endblock %}
