{% extends 'base.html' %}
{% block content %}
<h2>P치gina de carga</h2>

{# Estilos de UI movidos a static/css/app.css - incluidos en base.html #}

<div style="background-color: #15bedb; border: 1px solid #000000; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
    <strong>游늶 Configuraci칩n Actual:</strong> Quincena <strong>{{ qna_ini }}</strong> | Lote <strong>{{ lote_anterior }}</strong>
</div>

<div id="drop-area" class="drag-area">
    Arrastra y suelta archivos aqu칤 o haz clic para seleccionar.
    <input id="fileElem" type="file" multiple style="display:none" />
</div>

<div id="upload-result" style="margin-top:1rem;"></div>

{% if preview_records %}
<h3>Registros en Preview</h3>
<div style="margin-bottom: 20px;">
    <strong>Resumen:</strong> Tipo A: {{ tipo_a_count }} | Tipo B: {{ tipo_b_count }} | Total: {{ total_count }}
</div>
<form id="validation-form">
  <div class="table-responsive">
    <table role="grid"> {# Tabla de resultados #}
      <colgroup> {# Define el ancho de cada columna (se removi칩 'Cadena') #}
        <col style="width:10%">
        <col style="width:20%">
        <col style="width:4%">
        <col style="width:7%">
        <col style="width:4%">
        <col style="width:6%">
        <col style="width:6%">
        <col style="width:4%">
      </colgroup>
      <thead> {# Encabezado de la tabla #}
        <tr> {# Fila de Nombre de encabezados #}
          <th>RFC</th>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Importe</th>
          <th>CPTO</th>
          <th>Lote</th>
          <th>QNA</th>
          <th>Ptje</th>
        </tr>
      </thead>
      <tbody id="records-body">
        {% for r in preview_records %}
        <tr>
          <td><input type="text" name="rfc" value="{{ r.rfc|default:'' }}" maxlength="13" placeholder="RFC" title="RFC: {{ r.rfc|default:'N/A' }}"></td>
          <td><input type="text" name="nombre" value="{{ r.nombre|default:'' }}" maxlength="30" placeholder="Nombre" title="Nombre: {{ r.nombre|default:'N/A' }}"></td>
          <td><input type="text" name="tipo" value="{{ r.tipo|default:'' }}" maxlength="1" placeholder="Tipo" title="Tipo: {{ r.tipo|default:'N/A' }}"></td>
          <td><input type="text" name="impor" value="{{ r.impor|default:'' }}" maxlength="8" placeholder="Importe" title="Importe: {{ r.impor|default:'N/A' }}"></td>
          <td><input type="text" name="cpto" value="{{ r.cpto|default:'' }}" maxlength="2" placeholder="Cpto" title="Cpto: {{ r.cpto|default:'N/A' }}"></td>
          <td><input type="text" name="lote_actual" value="{{ r.lote_actual|default:'' }}" maxlength="1" placeholder="Lote Actual" title="Lote Actual: {{ r.lote_actual|default:'N/A' }}"></td>
          <td><input type="text" name="qna" value="{{ r.qna|default:'' }}" maxlength="6" placeholder="QNA" title="QNA: {{ r.qna|default:'N/A' }}"></td>
          <td><input type="text" name="ptje" value="{{ r.ptje|default:'' }}" maxlength="2" placeholder="Ptje" title="Ptje: {{ r.ptje|default:'N/A' }}"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
        <label><strong>쯃os registros son correctos? Favor de validarlo:</strong></label><br>
        <button type="button" id="confirm-btn" class="btn-entrar">Registros correctos</button>
        <button type="button" id="reject-btn" class="btn-entrar">Registros incorrectos</button>
    </div>
    <!-- Modal para opci칩n de carga m칰ltiple -->
    <div id="multiple-load-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 400px;">
            <h3>쮻eseas cargar otro archivo con la misma Quincena Proceso?</h3>
            <button type="button" id="yes-multiple-btn" class="btn-entrar">S칤</button>
            <button type="button" id="no-multiple-btn" class="btn-entrar">No</button>
            <!-- Formulario para nuevo lote (oculto inicialmente) -->
            <div id="new-lote-form" style="display: none; margin-top: 20px;">
                <label for="new-lote">Ingrese nuevo Lote (4 d칤gitos):</label>
                <input type="text" id="new-lote" name="new-lote" pattern="\d{4}" maxlength="4" required>
                <button type="button" id="submit-new-lote" class="btn-entrar">Actualizar Lote</button>
    </div>
</form>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    console.log('DOM cargado, inicializando drag & drop...');

    const dropArea = document.getElementById('drop-area');
    const fileElem = document.getElementById('fileElem');

    if (!dropArea || !fileElem) {
      console.error('Error: Elementos drop-area o fileElem no encontrados en el DOM.');
      return;
    }

    ['dragenter','dragover','dragleave','drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults (e) { 
      e.preventDefault(); 
      e.stopPropagation(); 
    }

    dropArea.addEventListener('drop', handleDrop, false);
    dropArea.addEventListener('click', () => fileElem.click());
    fileElem.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleDrop(e) { 
      handleFiles(e.dataTransfer.files); 
    }

    function handleFiles(files) {
      const formData = new FormData();
      for (let i=0; i<files.length; i++) formData.append('files', files[i]);
      const out = document.getElementById('upload-result');
      if (out) out.innerHTML = 'Procesando preview...';
  fetch("{% url 'api_preview' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
      })
      .then(async r => {
        let data;
        try { data = await r.json(); } catch(e) { data = { ok:false, error: 'Respuesta no v치lida del servidor' }; }
        if (!r.ok) throw data;
        return data;
      })
      .then(data => {
        if (data.ok) {
          out.innerHTML = `Preview cargado: ${data.preview_count} registros.` + (data.errors.length ? ` Errores: ${data.errors.length}` : '');
          setTimeout(() => location.reload(), 800);
        } else {
          out.innerHTML = `Error en preview: ${data.error}`;
        }
      })
      .catch(err => {
        out.innerHTML = `Fall칩 el preview: ${err.error || err}`;
      });
    }

    // Eventos de botones con verificaciones
    const confirmBtn = document.getElementById('confirm-btn');
    const rejectBtn = document.getElementById('reject-btn');
    const yesBtn = document.getElementById('yes-multiple-btn');
    const noBtn = document.getElementById('no-multiple-btn');
    const submitLoteBtn = document.getElementById('submit-new-lote');

    if (confirmBtn) {
      confirmBtn.addEventListener('click', () => {
        console.log('Bot칩n Registros correctos clicado');
        const out = document.getElementById('upload-result');
        if (out) out.innerHTML = 'Confirmando carga...';
        const payload = new FormData();
        payload.append('confirm', '1');
        fetch("{% url 'api_upload' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') },
          body: payload
        })
        .then(async r => {
          let data;
          try { data = await r.json(); } catch(e) { data = { ok:false, error: 'Respuesta no v치lida' }; }
          if (!r.ok) throw data;
          return data;
        })
        .then(data => {
          if (data.ok) {
            if (out) out.innerHTML = `Registros guardados: ${data.created}`;
            // Mostrar modal para preguntar si desea cargar otro archivo
            const modal = document.getElementById('multiple-load-modal');
            if (modal) modal.style.display = 'block';
          } else {
            if (out) out.innerHTML = 'Error al confirmar: ' + (data.error || JSON.stringify(data));
          }
        })
        .catch(err => {
          if (out) out.innerHTML = 'Error al confirmar: ' + (err.error || err);
        });
      });
    }

    if (rejectBtn) {
      rejectBtn.addEventListener('click', () => {
          // Llamar al endpoint para limpiar el preview en sesi칩n y recargar la p치gina
    fetch("{% url 'api_clear_preview' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
          })
          .then(r => r.json())
          .then(data => {
            if (data.ok) location.reload();
            else alert('No se pudo limpiar el preview: ' + (data.error || 'error'));
          })
          .catch(err => alert('Error al limpiar preview: ' + err));
      });
    }

    if (yesBtn) {
      yesBtn.addEventListener('click', () => {
        const form = document.getElementById('new-lote-form');
        if (form) form.style.display = 'block';
      });
    }

    if (noBtn) {
      noBtn.addEventListener('click', () => {
          // El usuario no desea cargar m치s archivos: cerrar modal y redirigir a configuraci칩n
          const modal = document.getElementById('multiple-load-modal');
          if (modal) modal.style.display = 'none';
          window.location.href = "{% url 'qnaproceso' %}";
      });
    }

    if (submitLoteBtn) {
      submitLoteBtn.addEventListener('click', () => {
        const newLote = document.getElementById('new-lote')?.value;
        if (newLote && newLote.length === 4) {
          fetch("{% url 'api_update_lote' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: new URLSearchParams({ nuevo_lote: newLote })
          })
          .then(r => r.json())
          .then(data => {
            if (data.ok) {
              const modal = document.getElementById('multiple-load-modal');
              if (modal) modal.style.display = 'none';
              location.reload();
            } else {
              alert(data.error);
            }
          });
        } else {
          alert('Ingrese un lote v치lido de 4 d칤gitos.');
        }
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  } catch (error) {
    console.error('Error al inicializar drag & drop:', error);
  }
});
</script>
{% endblock %}
