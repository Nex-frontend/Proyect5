{% extends 'base.html' %}
{% block content %}
<h2>Página de carga</h2>

<div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
    <strong>📋 Configuración Actual:</strong> Quincena <strong>{{ qna_ini }}</strong> | Lote <strong>{{ lote_anterior }}</strong>
</div>

<div id="drop-area" class="drag-area">
    Arrastra y suelta archivos aquí o haz clic para seleccionar.
    <input id="fileElem" type="file" multiple style="display:none" />
</div>

<div id="upload-result" style="margin-top:1rem;"></div>

{% if preview_records %}
<h3>Registros en Preview</h3>
<div style="margin-bottom: 20px;">
    <strong>Resumen:</strong> Tipo A: {{ tipo_a_count }} | Tipo B: {{ tipo_b_count }} | Total: {{ total_count }}
</div>
<form id="validation-form">
    <table role="grid">
        <thead>
            <tr>
                <th>RFC</th>
                <th>Nombre</th>
                <th>Cadena1</th>
                <th>Tipo</th>
                <th>Importe</th>
                <th>Cpto</th>
                <th>Lote Actual</th>
                <th>QNA</th>
                <th>Ptje</th>
                <th>Observación</th>
                <th>Lote Anterior</th>
                <th>QNA Inicial</th>
            </tr>
        </thead>
        <tbody id="records-body">
            {% for r in preview_records %}
            <tr>
                <td><input type="text" name="rfc" value="{{ r.rfc|default:'' }}" maxlength="13" placeholder="RFC" title="RFC: {{ r.rfc|default:'N/A' }}"></td>
                <td><input type="text" name="nombre" value="{{ r.nombre|default:'' }}" maxlength="30" placeholder="Nombre" title="Nombre: {{ r.nombre|default:'N/A' }}"></td>
                <td><input type="text" name="cadena1" value="{{ r.cadena1|default:'' }}" maxlength="37" placeholder="Cadena1" title="Cadena1: {{ r.cadena1|default:'N/A' }}"></td>
                <td><input type="text" name="tipo" value="{{ r.tipo|default:'' }}" maxlength="1" placeholder="Tipo" title="Tipo: {{ r.tipo|default:'N/A' }}"></td>
                <td><input type="text" name="impor" value="{{ r.impor|default:'' }}" maxlength="8" placeholder="Importe" title="Importe: {{ r.impor|default:'N/A' }}"></td>
                <td><input type="text" name="cpto" value="{{ r.cpto|default:'' }}" maxlength="2" placeholder="Cpto" title="Cpto: {{ r.cpto|default:'N/A' }}"></td>
                <td><input type="text" name="lote_actual" value="{{ r.lote_actual|default:'' }}" maxlength="1" placeholder="Lote Actual" title="Lote Actual: {{ r.lote_actual|default:'N/A' }}"></td>
                <td><input type="text" name="qna" value="{{ r.qna|default:'' }}" maxlength="6" placeholder="QNA" title="QNA: {{ r.qna|default:'N/A' }}"></td>
                <td><input type="text" name="ptje" value="{{ r.ptje|default:'' }}" maxlength="2" placeholder="Ptje" title="Ptje: {{ r.ptje|default:'N/A' }}"></td>
                <td><input type="text" name="observacio" value="{{ r.observacio|default:'' }}" maxlength="47" placeholder="Observación" title="Observación: {{ r.observacio|default:'N/A' }}"></td>
                <td><input type="text" name="lote_anterior" value="{{ r.lote_anterior|default:'' }}" maxlength="5" placeholder="Lote Anterior" title="Lote Anterior: {{ r.lote_anterior|default:'N/A' }}"></td>
                <td><input type="text" name="qna_ini" value="{{ r.qna_ini|default:'' }}" maxlength="6" placeholder="QNA Inicial" title="QNA Inicial: {{ r.qna_ini|default:'N/A' }}"></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
        <label><strong>¿Los registros son correctos? Favor de validarlo:</strong></label><br>
        <button type="button" id="confirm-btn" class="btn-entrar">Registros correctos</button>
        <button type="button" id="reject-btn" class="btn-entrar">Registros incorrectos</button>
    </div>
    <!-- Modal para opción de carga múltiple -->
    <div id="multiple-load-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 400px;">
            <h3>¿Deseas cargar otro archivo con la misma Quincena Proceso?</h3>
            <button type="button" id="yes-multiple-btn" class="btn-entrar">Sí</button>
            <button type="button" id="no-multiple-btn" class="btn-entrar">No</button>
            <!-- Formulario para nuevo lote (oculto inicialmente) -->
            <div id="new-lote-form" style="display: none; margin-top: 20px;">
                <label for="new-lote">Ingrese nuevo Lote (4 dígitos):</label>
                <input type="text" id="new-lote" name="new-lote" pattern="\d{4}" maxlength="4" required>
                <button type="button" id="submit-new-lote" class="btn-entrar">Actualizar Lote</button>
    </div>
</form>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    console.log('DOM cargado, inicializando drag & drop...');

    const dropArea = document.getElementById('drop-area');
    const fileElem = document.getElementById('fileElem');

    if (!dropArea || !fileElem) {
      console.error('Error: Elementos drop-area o fileElem no encontrados en el DOM.');
      return;
    }

    ['dragenter','dragover','dragleave','drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults (e) { 
      e.preventDefault(); 
      e.stopPropagation(); 
    }

    dropArea.addEventListener('drop', handleDrop, false);
    dropArea.addEventListener('click', () => fileElem.click());
    fileElem.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleDrop(e) { 
      handleFiles(e.dataTransfer.files); 
    }

    function handleFiles(files) {
      const formData = new FormData();
      for (let i=0; i<files.length; i++) formData.append('files', files[i]);
      const out = document.getElementById('upload-result');
      if (out) out.innerHTML = 'Procesando preview...';
  fetch("{% url 'api_preview' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
      })
      .then(async r => {
        let data;
        try { data = await r.json(); } catch(e) { data = { ok:false, error: 'Respuesta no válida del servidor' }; }
        if (!r.ok) throw data;
        return data;
      })
      .then(data => {
        if (data.ok) {
          out.innerHTML = `Preview cargado: ${data.preview_count} registros.` + (data.errors.length ? ` Errores: ${data.errors.length}` : '');
          setTimeout(() => location.reload(), 800);
        } else {
          out.innerHTML = `Error en preview: ${data.error}`;
        }
      })
      .catch(err => {
        out.innerHTML = `Falló el preview: ${err.error || err}`;
      });
    }

    // Eventos de botones con verificaciones
    const confirmBtn = document.getElementById('confirm-btn');
    const rejectBtn = document.getElementById('reject-btn');
    const yesBtn = document.getElementById('yes-multiple-btn');
    const noBtn = document.getElementById('no-multiple-btn');
    const submitLoteBtn = document.getElementById('submit-new-lote');

    if (confirmBtn) {
      confirmBtn.addEventListener('click', () => {
        console.log('Botón Registros correctos clicado');
        const modal = document.getElementById('multiple-load-modal');
        if (modal) modal.style.display = 'block';
      });
    }

    if (rejectBtn) {
      rejectBtn.addEventListener('click', () => {
          // Llamar al endpoint para limpiar el preview en sesión y recargar la página
    fetch("{% url 'api_clear_preview' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
          })
          .then(r => r.json())
          .then(data => {
            if (data.ok) location.reload();
            else alert('No se pudo limpiar el preview: ' + (data.error || 'error'));
          })
          .catch(err => alert('Error al limpiar preview: ' + err));
      });
    }

    if (yesBtn) {
      yesBtn.addEventListener('click', () => {
        const form = document.getElementById('new-lote-form');
        if (form) form.style.display = 'block';
      });
    }

    if (noBtn) {
      noBtn.addEventListener('click', () => {
          // El usuario confirma que no desea cargar más archivos: proceder a confirmar la carga
          const out = document.getElementById('upload-result');
          if (out) out.innerHTML = 'Confirmando carga...';
          const payload = new FormData();
          payload.append('confirm', '1');
    fetch("{% url 'api_upload' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: payload
          })
          .then(async r => {
            let data;
            try { data = await r.json(); } catch(e) { data = { ok:false, error: 'Respuesta no válida' }; }
            if (!r.ok) throw data;
            return data;
          })
          .then(data => {
            if (data.ok) {
              window.location.href = "{% url 'resultados' %}";
            } else {
              if (out) out.innerHTML = 'Error al confirmar: ' + (data.error || JSON.stringify(data));
            }
          })
          .catch(err => {
            if (out) out.innerHTML = 'Error al confirmar: ' + (err.error || err);
          });
      });
    }

    if (submitLoteBtn) {
      submitLoteBtn.addEventListener('click', () => {
        const newLote = document.getElementById('new-lote')?.value;
        if (newLote && newLote.length === 4) {
          fetch("{% url 'api_update_lote' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: new URLSearchParams({ nuevo_lote: newLote })
          })
          .then(r => r.json())
          .then(data => {
            if (data.ok) {
              const modal = document.getElementById('multiple-load-modal');
              if (modal) modal.style.display = 'none';
              location.reload();
            } else {
              alert(data.error);
            }
          });
        } else {
          alert('Ingrese un lote válido de 4 dígitos.');
        }
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  } catch (error) {
    console.error('Error al inicializar drag & drop:', error);
  }
});
</script>
{% endblock %}
