{% extends 'base.html' %}
{% block content %}
<h2>Página de carga</h2>
<div id="drop-area" class="drag-area">
  Arrastra y suelta archivos aquí o haz clic para seleccionar.
  <input id="fileElem" type="file" multiple style="display:none" />
</div>

<div id="upload-result" style="margin-top:1rem;"></div>

<h3>Registros cargados</h3>
<table role="grid">
  <thead>
    <tr>
      <th>RFC</th>
      <th>Nombre</th>
      <th>Cadena1</th>
      <th>Tipo</th>
      <th>Importe</th>
      <th>CPTO</th>
      <th>Lote act.</th>
      <th>QNA</th>
      <th>Ptje</th>
      <th>Observación</th>
      <th>Lote ant.</th>
      <th>QNA ini</th>
    </tr>
  </thead>
  <tbody id="records-body">
    {% for r in records %}
    <tr>
      <td>{{ r.rfc }}</td>
      <td>{{ r.nombre }}</td>
      <td>{{ r.cadena1 }}</td>
      <td>{{ r.tipo }}</td>
      <td>{{ r.impor }}</td>
      <td>{{ r.cpto }}</td>
      <td>{{ r.lote_actual }}</td>
      <td>{{ r.qna }}</td>
      <td>{{ r.ptje }}</td>
      <td>{{ r.observacio }}</td>
      <td>{{ r.lote_anterior }}</td>
      <td>{{ r.qna_ini }}</td>
    </tr>
    {% endfor %}
  </tbody>
  <caption>Total mostrados: {{ records|length }}</caption>
  </table>

<script>
const dropArea = document.getElementById('drop-area');
const fileElem = document.getElementById('fileElem');

['dragenter','dragover','dragleave','drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false)
});

function preventDefaults (e) { e.preventDefault(); e.stopPropagation(); }

dropArea.addEventListener('drop', handleDrop, false);
dropArea.addEventListener('click', () => fileElem.click());
fileElem.addEventListener('change', (e) => handleFiles(e.target.files));

function handleDrop(e) { handleFiles(e.dataTransfer.files); }

function handleFiles(files) {
  const formData = new FormData();
  for (let i=0; i<files.length; i++) formData.append('files', files[i]);
  const out = document.getElementById('upload-result');
  out.innerHTML = 'Subiendo...';
  fetch('{% url 'api_upload' %}', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: formData
    })
    .then(async r => {
      let data;
      try { data = await r.json(); } catch(e) { data = { ok:false, error: 'Respuesta no válida del servidor' }; }
      if (!r.ok) throw data;
      return data;
    })
    .then(data => {
      if (data.ok) {
        out.innerHTML = `Cargados: ${data.created}.` + (data.errors && data.errors.length ? ` Errores: ${data.errors.length}` : '');
        // Refresca la tabla para ver nuevos registros
        setTimeout(() => location.reload(), 800);
      } else {
        out.innerHTML = `Error: ${data.error || 'Error desconocido'}`;
      }
    })
    .catch(err => {
      const msg = err && err.error ? err.error : (typeof err === 'string' ? err : 'Error desconocido (¿permisos? ¿CSRF? ¿Conexión a BD?)');
      out.innerHTML = `Falló la carga: ${msg}`;
    });
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}
</script>
{% endblock %}
