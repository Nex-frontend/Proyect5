{% extends 'base.html' %}
{% block content %}
<h2>Página de carga</h2>

<div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
    <strong>📋 Configuración Actual:</strong> Quincena <strong>{{ qna_ini }}</strong> | Lote <strong>{{ lote_anterior }}</strong>
</div>

<div id="drop-area" class="drag-area">
    Arrastra y suelta archivos aquí o haz clic para seleccionar.
    <input id="fileElem" type="file" multiple style="display:none" />
</div>

<div id="upload-result" style="margin-top:1rem;"></div>

{% if preview_records %}
<h3>Registros en Preview</h3>
<div style="margin-bottom: 20px;">
    <strong>Resumen:</strong> Tipo A: {{ tipo_a_count }} | Tipo B: {{ tipo_b_count }} | Total: {{ total_count }}
</div>
<form id="validation-form">
    <table role="grid">
        <thead>
            <tr>
                <th>RFC</th>
                <th>Nombre</th>
                <th>Cadena1</th>
                <th>Tipo</th>
                <th>Importe</th>
                <th>CPTO</th>
                <th>Lote act.</th>
                <th>QNA</th>
                <th>Ptje</th>
                <th>Observación</th>
                <th>Lote ant.</th>
                <th>QNA ini</th>
            </tr>
        </thead>
        <tbody id="records-body">
            {% for r in preview_records %}
            <tr>
                <td><input type="text" name="rfc" value="{{ r.rfc }}" maxlength="13"></td>
                <td><input type="text" name="nombre" value="{{ r.nombre }}" maxlength="30"></td>
                <td><input type="text" name="cadena1" value="{{ r.cadena1 }}" maxlength="37"></td>
                <td><input type="text" name="tipo" value="{{ r.tipo }}" maxlength="1"></td>
                <td><input type="text" name="impor" value="{{ r.impor }}" maxlength="8"></td>
                <td><input type="text" name="cpto" value="{{ r.cpto }}" maxlength="2"></td>
                <td><input type="text" name="lote_actual" value="{{ r.lote_actual }}" maxlength="1"></td>
                <td><input type="text" name="qna" value="{{ r.qna }}" maxlength="6"></td>
                <td><input type="text" name="ptje" value="{{ r.ptje }}" maxlength="2"></td>
                <td><input type="text" name="observacio" value="{{ r.observacio }}" maxlength="47"></td>
                <td><input type="text" name="lote_anterior" value="{{ r.lote_anterior }}" maxlength="5"></td>
                <td><input type="text" name="qna_ini" value="{{ r.qna_ini }}" maxlength="6"></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="margin-top: 20px;">
        <label><strong>¿Los registros son correctos? Favor de validarlo:</strong></label><br>
        <button type="button" id="confirm-btn" class="btn-entrar">Registros correctos</button>
        <button type="button" id="reject-btn" class="btn-entrar">Registros incorrectos</button>
    </div>
    <!-- Modal para opción de carga múltiple -->
    <div id="multiple-load-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 400px;">
            <h3>¿Deseas cargar otro archivo con la misma Quincena Proceso?</h3>
            <button type="button" id="yes-multiple-btn" class="btn-entrar">Sí</button>
            <button type="button" id="no-multiple-btn" class="btn-entrar">No</button>
            <!-- Formulario para nuevo lote (oculto inicialmente) -->
            <div id="new-lote-form" style="display: none; margin-top: 20px;">
                <label for="new-lote">Ingrese nuevo Lote (4 dígitos):</label>
                <input type="text" id="new-lote" name="new-lote" pattern="\d{4}" maxlength="4" required>
                <button type="button" id="submit-new-lote" class="btn-entrar">Actualizar Lote</button>
            </div>
    </div>
</form>
{% endif %}

<script>
console.log('DEBUG: Preview records en template:', {{ preview_records|length }});  // Depuración temporal
console.log('DEBUG: Tipo A:', {{ tipo_a_count }});  // Depuración temporal
console.log('DEBUG: Tipo B:', {{ tipo_b_count }});  // Depuración temporal
console.log('DEBUG: Total:', {{ total_count }});  // Depuración temporal
const fileElem = document.getElementById('fileElem');

['dragenter','dragover','dragleave','drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false);
});
function preventDefaults (e) { e.preventDefault(); e.stopPropagation(); }

dropArea.addEventListener('drop', handleDrop, false);
dropArea.addEventListener('click', () => fileElem.click());
fileElem.addEventListener('change', (e) => handleFiles(e.target.files));

function handleDrop(e) { handleFiles(e.dataTransfer.files); }

function handleFiles(files) {
  const formData = new FormData();
  for (let i=0; i<files.length; i++) formData.append('files', files[i]);
  const out = document.getElementById('upload-result');
  out.innerHTML = 'Procesando preview...';
  fetch('{% url 'api_preview' %}', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: formData
    })
    .then(async r => {
      let data;
      try { data = await r.json(); } catch(e) { data = { ok:false, error: 'Respuesta no válida del servidor' }; }
      if (!r.ok) throw data;
      return data;
    })
    .then(data => {
      if (data.ok) {
        out.innerHTML = `Preview cargado: ${data.preview_count} registros.` + (data.errors.length ? ` Errores: ${data.errors.length}` : '');
        setTimeout(() => location.reload(), 800);
      } else {
        out.innerHTML = `Error en preview: ${data.error}`;
      }
    })
    .catch(err => {
      out.innerHTML = `Falló el preview: ${err.error || err}`;
    });
}

// Botones de validación
document.getElementById('confirm-btn')?.addEventListener('click', () => {
  console.log('DEBUG: Botón Registros correctos clicado');  // Depuración
  // Mostrar modal para opción de carga múltiple
  document.getElementById('multiple-load-modal').style.display = 'block';
  console.log('DEBUG: Modal mostrado');  // Depuración
});

document.getElementById('reject-btn')?.addEventListener('click', () => {
  // Limpiar sesiones y volver a qnaproceso
  fetch('{% url 'api_upload' %}', { method: 'POST', body: new FormData() })
    .then(() => window.location.href = '{% url 'qnaproceso' %}');
});

document.getElementById('yes-multiple-btn')?.addEventListener('click', () => {
  console.log('DEBUG: Botón Sí clicado');  // Depuración
  // Mostrar formulario para nuevo lote
  document.getElementById('new-lote-form').style.display = 'block';
});

document.getElementById('no-multiple-btn')?.addEventListener('click', () => {
  console.log('DEBUG: Botón No clicado');  // Depuración
  // Redirigir a qnaproceso sin cargar más
  window.location.href = '{% url 'qnaproceso' %}';
});

document.getElementById('submit-new-lote')?.addEventListener('click', () => {
  console.log('DEBUG: Botón Actualizar Lote clicado');  // Depuración
  const newLote = document.getElementById('new-lote').value;
  console.log('DEBUG: Nuevo lote ingresado:', newLote);  // Depuración
  if (newLote && newLote.length === 4) {
    // Actualizar lote en sesión
    fetch('{% url 'api_update_lote' %}', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: new URLSearchParams({ nuevo_lote: newLote })
    })
    .then(r => r.json())
    .then(data => {
      console.log('DEBUG: Respuesta de api_update_lote:', data);  // Depuración
      if (data.ok) {
        // Ocultar modal y recargar página para proceder al preview
        document.getElementById('multiple-load-modal').style.display = 'none';
        location.reload();
      } else {
        alert(data.error);
      }
    });
  } else {
    alert('Ingrese un lote válido de 4 dígitos.');
  }
});

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}
</script>
{% endblock %}
